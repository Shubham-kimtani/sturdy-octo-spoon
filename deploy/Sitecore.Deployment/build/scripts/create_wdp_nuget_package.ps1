Param(
    [Parameter(Mandatory=$true)]
    [string] $PackageName,

    [Parameter(Mandatory=$true)]
    [string] $OutputDirectory,

    [Parameter(Mandatory=$true)]
    [string] $InputDirectory,

	[Parameter(Mandatory=$true)]
    [string] $Version
)
$ErrorActionPreference = "Stop"

function Create-NuSpecFile([string] $Path, [string] $Name, [string] $Version) {
	$xmlPath = "$Path\$Name.nuspec"
	$xmlWriter = New-Object System.XMl.XmlTextWriter($xmlPath,$Null)
	$xmlWriter.Formatting = 'Indented'
	$xmlWriter.Indentation = 1
	$xmlWriter.IndentChar = "`t"
	$xmlWriter.WriteStartDocument()

	#create package nodde
	$xmlWriter.WriteStartElement("package","http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd")
	
	#create metadata node
	$xmlWriter.WriteStartElement("metadata");

	#write the required nuspec fields
	$xmlWriter.WriteElementString("id", $Name);
	$xmlWriter.WriteElementString("version", $Version);
	$xmlWriter.WriteElementString("authors", "Aarambh");
	$xmlWriter.WriteElementString("description", "Package that contains the $Name.update file generated by TDS for Sitecore.");

	#close the metadata and package nodes
	$xmlWriter.WriteEndElement();
	$xmlWriter.WriteEndElement();

	#write to file
	$xmlWriter.Close();
}

Write-Host "Creating a single nuspec file for all projects."
Create-NuSpecFile -path $InputDirectory -Name $PackageName -Version $Version

Get-ChildItem $InputDirectory | Compress-Archive -DestinationPath "$OutputDirectory\$PackageName.zip"
Get-ChildItem $OutputDirectory -Filter "$PackageName.zip" | Rename-Item -NewName "$PackageName.$version.nupkg"